# Nixpacks config for Santos Store (Next.js)
# better-sqlite3 needs python + gcc to compile its native addon

[phases.setup]
nixPkgs = ["python3", "gcc", "gnumake", "nodejs_20"]

[phases.install]
cmds = ["npm ci", "npm rebuild better-sqlite3 --build-from-source"]

[phases.build]
# Clear stale Docker cache mounts BEFORE build (same RUN = same mount)
cmds = ["rm -rf .next/cache/* node_modules/.cache/* 2>/dev/null; NODE_ENV=production npm run build", "mkdir -p uploads", "mkdir -p data"]

[start]
cmd = "npm run start"
